<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁèæÊò† GENEI | OTAKU CREATIVE BASE</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Orbitron:wght@500;700;900&family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=Rock+Salt&family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, addDoc, query, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signOut,
            getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, addDoc, query, onSnapshot, deleteDoc, serverTimestamp
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        impact: ['"Orbitron"', '"Dela Gothic One"', 'sans-serif'],
                        sans: ['"Orbitron"', '"Zen Kaku Gothic New"', 'sans-serif'],
                        messy: ['"Rock Salt"', 'cursive'],
                        pixel: ['"VT323"', 'monospace'],
                    },
                    colors: {
                        'base-white': '#fcfcfc',
                        'base-black': '#1a1a1a',
                        'neon-cyan': '#00a3cc', 
                        'neon-pink': '#d60080',
                        'neon-yellow': '#e6b800',
                        'neon-lime': '#2cb30e',
                        'neon-purple': '#9d00d6',
                    },
                    backgroundImage: {
                        'grid-cyber': 'linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px)',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'spin-slow': 'spin 4s linear infinite',
                        'rgb-pulse': 'rgbPulse 2s infinite',
                        'glitch-screen': 'glitchScreen 0.2s cubic-bezier(.25, .46, .45, .94) both infinite',
                    },
                    keyframes: {
                        rgbPulse: {
                            '0%, 100%': { borderColor: '#00a3cc', boxShadow: '5px 5px 0px #00a3cc' },
                            '25%': { borderColor: '#d60080', boxShadow: '5px 5px 0px #d60080' },
                            '50%': { borderColor: '#e6b800', boxShadow: '5px 5px 0px #e6b800' },
                            '75%': { borderColor: '#2cb30e', boxShadow: '5px 5px 0px #2cb30e' },
                        },
                        glitchScreen: {
                            '0%': { transform: 'translate(0)' },
                            '20%': { transform: 'translate(-2px, 2px) skewX(-2deg)' },
                            '40%': { transform: 'translate(-2px, -2px) skewX(2deg)' },
                            '60%': { transform: 'translate(2px, 2px) skewX(-2deg)' },
                            '80%': { transform: 'translate(2px, -2px) skewX(2deg)' },
                            '100%': { transform: 'translate(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES (White Theme) --- */
        body {
            background-color: #fcfcfc;
            color: #1a1a1a;
            overflow-x: hidden;
            font-family: sans-serif;
            cursor: none; 
            background-image: 
                radial-gradient(#ddd 15%, transparent 16%),
                radial-gradient(#eee 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        /* --- LOADING SCREEN (Black Theme) --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background-color: #0a0a0a; /* Black background */
            color: #fff;
            z-index: 999999;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        /* Specific overrides for loading screen */
        #loading-screen .border-black { border-color: #fff !important; }
        #loading-screen .text-black { color: #fff !important; }
        #loading-screen .bg-white { background-color: #000 !important; color: #fff !important; }
        #loading-screen .shadow-\[5px_5px_0px_\#ccc\] { box-shadow: 5px 5px 0px #333 !important; }

        #main-content {
            opacity: 0; 
            visibility: hidden;
            position: relative; 
        }

        /* --- UI COMPONENTS --- */
        a, button, .pointer-events-auto, .cursor-pointer {
            cursor: none !important;
        }

        .speed-lines {
            position: fixed;
            inset: 0;
            background: repeating-conic-gradient(
                from 0deg,
                transparent 0deg 10deg,
                rgba(0, 0, 0, 0.02) 10deg 20deg
            );
            pointer-events: none;
            z-index: -1;
            opacity: 0.5;
        }

        #start-button {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s;
        }
        #start-button:hover {
            box-shadow: 0 0 20px #2cb30e, inset 0 0 20px #2cb30e;
            color: #0a0a0a !important;
            background: #2cb30e !important;
            border-color: #2cb30e !important;
            transform: scale(1.1);
        }

        .title-impact {
            font-family: 'Chakra Petch', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 3px 3px 0px #ccc;
        }

        .rgb-text {
            position: relative;
            display: inline-block;
        }
        .rgb-text::before, .rgb-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0.6;
            mix-blend-mode: multiply; 
            z-index: -1;
        }
        .rgb-text::before { color: #00a3cc; transform: translate(-2px, -2px); }
        .rgb-text::after { color: #d60080; transform: translate(2px, 2px); }

        .otaku-border {
            border: 4px solid #1a1a1a;
            background: #fff;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            clip-path: polygon(2% 0, 98% 0, 100% 2%, 100% 98%, 98% 100%, 2% 100%, 0 98%, 0 2%);
        }
        .otaku-border:hover {
            transform: translate(-5px, -5px) scale(1.02);
            z-index: 20;
        }
        
        .otaku-border.no-hover-effect {
            transform: none !important;
            transition: none !important;
        }
        .otaku-border.no-hover-effect:hover {
            transform: none !important;
        }

        .shadow-cyan:hover { box-shadow: 10px 10px 0px #00a3cc; border-color: #00a3cc; }
        .shadow-pink:hover { box-shadow: 10px 10px 0px #d60080; border-color: #d60080; }
        .shadow-lime:hover { box-shadow: 10px 10px 0px #2cb30e; border-color: #2cb30e; }
        .shadow-yellow:hover { box-shadow: 10px 10px 0px #e6b800; border-color: #e6b800; }

        .menu-link {
            position: relative;
            display: inline-block;
            padding: 5px 20px;
            background: #fff;
            color: #1a1a1a;
            transform: skew(-15deg);
            transition: all 0.2s;
            border: 2px solid #ccc;
            cursor: none;
            font-weight: 900;
            pointer-events: auto !important; 
        }
        .menu-link:hover, .menu-link.active {
            background: #1a1a1a;
            color: #fff;
            transform: skew(-15deg) translateX(-10px) scale(1.1);
            border-color: #1a1a1a;
            box-shadow: 2px 2px 0 #00a3cc, 4px 4px 0 #d60080, 6px 6px 0 #e6b800;
        }
        .menu-link span { display: block; transform: skew(15deg); }

        .sticker {
            position: absolute;
            padding: 4px 12px;
            font-family: 'Chakra Petch', sans-serif;
            text-transform: uppercase;
            font-weight: 700;
            border: 2px solid #1a1a1a;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
            transform: rotate(-10deg);
        }

        #cursor {
            position: fixed;
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23ff0000" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg>') no-repeat center center;
            background-size: contain;
            pointer-events: none;
            z-index: 2147483647; 
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }
        
        .hover-glitch:hover {
            animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
            color: #d60080;
            text-shadow: 2px 0 #00a3cc, -2px 0 #e6b800;
        }

        .init-hidden { opacity: 0; }

        .static-noise {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 9999999;
            pointer-events: none;
            opacity: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
            background-size: 150px 150px;
            animation: noise-anim 0.2s steps(4) infinite;
            display: none;
            mix-blend-mode: multiply;
            background-color: #ddd;
        }

        /* --- MODALS --- */
        #log-modal, #admin-modal, #post-modal, #ai-modal, #auth-modal, #alert-modal, #confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.85); 
            z-index: 99999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            opacity: 0;
            transform: scale(1);
        }
        
        .modal-scrollable-body {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        .modal-scrollable-body::-webkit-scrollbar { width: 6px; }
        .modal-scrollable-body::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); }
        .modal-scrollable-body::-webkit-scrollbar-thumb { background: #00a3cc; }

        .otaku-border.no-hover-transform:hover,
        #ai-modal .otaku-border:hover,
        #post-modal .otaku-border:hover,
        #auth-modal .otaku-border:hover,
        #alert-modal .otaku-border:hover,
        #confirm-modal .otaku-border:hover {
            transform: none !important;
            z-index: auto;
        }

        #achievement-toast {
            position: fixed;
            top: 20px;
            right: -400px;
            width: 300px;
            background: #fff;
            border: 2px solid #e6b800;
            z-index: 9999999;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.1);
            transform: skewX(-10deg);
            pointer-events: none;
        }
        
        .action-btn {
            padding: 2px 8px; font-size: 12px; font-weight: bold;
            border: 1px solid #1a1a1a; cursor: pointer !important; pointer-events: auto !important;
            box-shadow: 2px 2px 0 #ccc; transition: all 0.1s;
            position: relative; z-index: 100000;
        }
        .action-btn:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 #ccc; }
        
        .delete-btn { background: #ffeded; color: #d32f2f; border-color: #d32f2f; }
        .edit-btn { background: #e3f2fd; color: #0288d1; border-color: #0288d1; margin-right: 5px; }
        
        #ai-btn-container { position: fixed; bottom: 100px; right: 80px; z-index: 9000; }
        .ai-float-btn {
            background: #2cb30e; color: white; border: 2px solid #1a1a1a;
            width: 50px; height: 50px; clip-path: polygon(20% 0, 100% 0, 100% 80%, 80% 100%, 0 100%, 0 20%);
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; box-shadow: 3px 3px 0 #1a1a1a;
            transition: all 0.3s;
            overflow: hidden; 
        }
        .ai-float-btn:hover { transform: scale(1.1); }

        .chat-log {
            flex: 1; overflow-y: auto; background: #f5f5f5; padding: 10px;
            font-family: 'Zen Kaku Gothic New', sans-serif; font-size: 14px;
            border: 1px solid #ddd; margin-bottom: 10px;
        }
        .chat-msg.user { text-align: right; color: #00a3cc; }
        .chat-msg.ai { text-align: left; color: #2cb30e; border-left: 2px solid #2cb30e; padding-left: 8px; }

        /* Sound Bar Animation */
        #sound-toggle .bar {
            transition: height 0.05s ease;
        }
        #sound-toggle:not(.muted) .bar:nth-child(1) { animation: sound-bar-1 0.4s ease-in-out infinite alternate; }
        #sound-toggle:not(.muted) .bar:nth-child(2) { animation: sound-bar-2 0.5s ease-in-out infinite alternate; }
        #sound-toggle:not(.muted) .bar:nth-child(3) { animation: sound-bar-3 0.3s ease-in-out infinite alternate; }
        #sound-toggle:not(.muted) .bar:nth-child(4) { animation: sound-bar-4 0.45s ease-in-out infinite alternate; }

        @keyframes sound-bar-1 { 0% { height: 20%; } 50% { height: 80%; } 100% { height: 30%; } }
        @keyframes sound-bar-2 { 0% { height: 40%; } 50% { height: 90%; } 100% { height: 50%; } }
        @keyframes sound-bar-3 { 0% { height: 30%; } 50% { height: 100%; } 100% { height: 40%; } }
        @keyframes sound-bar-4 { 0% { height: 50%; } 50% { height: 70%; } 100% { height: 20%; } }

        /* ‚òÖ Film Strip Animation (Bold & Centered) ‚òÖ */
        .film-strip {
            position: absolute;
            top: 50%; 
            left: 50%; 
            width: 240px; /* Â§ßËÉÜ„Å´Â§™„Åè */
            height: 400vh; /* ÁîªÈù¢„ÇíÂçÅÂàÜË¶Ü„ÅÜÈï∑„Åï */
            background-color: #1a1a1a; 
            
            /* CSS„Å´„Çà„Çã„Éï„Ç£„É´„É†ÊèèÁîª („Éá„Éï„Ç©„É´„Éà) */
            background-image: url('film.png'),
                /* Â∑¶Á©¥: ÁôΩ(20px) + ÈÄèÊòé(20px) = 40px„Éî„ÉÉ„ÉÅ */
                linear-gradient(to bottom, #ffffff 20px, transparent 20px),
                /* Âè≥Á©¥ */
                linear-gradient(to bottom, #ffffff 20px, transparent 20px),
                /* „Éï„É¨„Éº„É†Êû† */
                linear-gradient(to bottom, transparent 156px, #fff 156px, #fff 158px, transparent 158px);
                
            background-size: 
                100% auto,
                24px 40px, /* Á©¥„Çµ„Ç§„Ç∫: ÂπÖ24px È´ò„Åï40px */
                24px 40px, 
                100% 160px; /* „Éï„É¨„Éº„É†È´ò„Åï 160px (40px * 4Á©¥ÂàÜ) */
                
            background-position: 
                0 0,
                12px 0,                /* Â∑¶Á©¥ */
                calc(100% - 36px) 0,   /* Âè≥Á©¥ */
                0 0;

            background-repeat: repeat-y;
            
            opacity: 0.15; /* ËÉåÊôØ„Å®„Åó„Å¶È¶¥Êüì„Åæ„Åõ„Çã */
            z-index: 0;
            pointer-events: none;
            
            /* ÁîªÈù¢‰∏≠Â§Æ„ÇíÂü∫Ê∫ñ„Å´ÂõûËª¢„Åó„Å¶Á∏¶Êñ≠ */
            transform-origin: center;
            transform: translate(-50%, -50%) rotate(-35deg); 
            
            animation: film-scroll 8s linear infinite;
        }

        @keyframes film-scroll {
            0% { background-position: 0 0, 12px 0, calc(100% - 36px) 0, 0 0; }
            /* „Éï„É¨„Éº„É†È´ò„Åï(160px)„ÅÆÂÄçÊï∞„ÅßÂãï„Åã„Åô */
            100% { background-position: 0 800px, 12px 800px, calc(100% - 36px) 800px, 0 800px; } 
        }
        
        /* Category Tab Styles */
        .category-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .category-tab {
            background: transparent;
            border: 2px solid #ccc;
            color: #999;
            padding: 5px 15px;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            cursor: pointer !important;
            transition: all 0.2s;
            pointer-events: auto;
        }
        .category-tab:hover, .category-tab.active {
            border-color: #00a3cc;
            color: #00a3cc;
            background: rgba(0, 163, 204, 0.1);
        }

    </style>
</head>
<body class="selection:bg-neon-pink selection:text-white">

    <!-- Achievement Toast -->
    <div id="achievement-toast">
        <div class="trophy-icon">üèÜ</div>
        <div>
            <div class="font-impact text-neon-yellow text-sm tracking-wider">ACHIEVEMENT UNLOCKED!</div>
            <div id="achievement-title" class="font-sans font-bold text-black text-xs mt-1"></div>
        </div>
    </div>

    <!-- Static Noise -->
    <div id="transition-noise" class="static-noise"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="pointer-events-auto">
        <div class="relative z-10 flex flex-col items-center w-full max-w-md">
            <!-- Logo -->
            <div class="mb-8 p-4">
                <img src="logo2.png" alt="GENEI" 
                     class="h-16 md:h-24 w-auto object-contain logo-flicker" 
                     onerror="this.style.display='none'; document.getElementById('loading-fallback').style.display='block';">
                <h1 id="loading-fallback" class="hidden text-5xl font-impact text-white logo-flicker">GENEI</h1>
            </div>

            <h2 id="loading-text" class="font-pixel text-5xl text-neon-cyan tracking-widest mb-4">LOADING...</h2>
            <div class="w-full h-6 border-4 border-white p-1 mb-8 skew-x-[-15deg] shadow-[5px_5px_0px_#ccc] bg-black">
                <div id="loading-bar" class="h-full bg-gradient-to-r from-neon-cyan via-neon-pink to-neon-yellow w-0"></div>
            </div>
            <button id="start-button" class="group relative cursor-none pointer-events-auto border-2 border-white px-12 py-4 skew-x-[-15deg] bg-black text-white font-impact text-2xl tracking-widest flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <span>PLAY</span>
            </button>
            <div id="loading-sub" class="mt-8 text-white font-impact text-sm px-2 py-1 transform skew-x-[-15deg] bg-neon-pink opacity-80">
                SYSTEM BOOT UP
            </div>
        </div>
    </div>

    <!-- ‚òÖ CUSTOM ALERT MODAL ‚òÖ -->
    <div id="alert-modal" class="pointer-events-auto">
        <div class="modal-content w-full max-w-sm mx-4 relative">
            <div class="otaku-border bg-white p-1 shadow-yellow border-neon-yellow no-hover-effect">
                <div class="bg-neon-yellow text-black font-impact px-4 py-1 flex justify-between items-center mb-4">
                    <span>SYSTEM_ALERT</span>
                    <button onclick="document.getElementById('alert-modal').style.display='none'" class="hover:text-white">[X]</button>
                </div>
                <div class="p-6 text-center">
                    <p id="alert-msg" class="font-bold mb-6 text-sm"></p>
                    <button onclick="document.getElementById('alert-modal').style.display='none'" class="bg-black text-white px-6 py-2 font-impact hover:bg-gray-800">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚òÖ CUSTOM CONFIRM MODAL ‚òÖ -->
    <div id="confirm-modal" class="pointer-events-auto">
        <div class="modal-content w-full max-w-sm mx-4 relative">
            <div class="otaku-border bg-white p-1 shadow-pink border-neon-pink no-hover-effect">
                <div class="bg-neon-pink text-white font-impact px-4 py-1 flex justify-between items-center mb-4">
                    <span>CONFIRMATION_REQUIRED</span>
                    <button onclick="document.getElementById('confirm-modal').style.display='none'" class="hover:text-black">[X]</button>
                </div>
                <div class="p-6 text-center">
                    <p id="confirm-msg" class="font-bold mb-6 text-sm">Are you sure?</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="document.getElementById('confirm-modal').style.display='none'" class="border-2 border-black text-black px-4 py-2 font-impact hover:bg-gray-100">CANCEL</button>
                        <button id="confirm-yes-btn" class="bg-neon-pink text-white px-6 py-2 font-impact hover:bg-red-600">YES, DO IT</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Auth Modal -->
    <div id="auth-modal" class="pointer-events-auto">
        <div class="modal-content w-full max-w-md mx-4 relative">
            <div class="otaku-border bg-white p-1 shadow-purple border-neon-purple no-hover-effect">
                <div class="bg-neon-purple text-white font-impact px-4 py-1 flex justify-between items-center mb-4">
                    <span>SECURITY_GATE</span>
                    <button onclick="document.getElementById('auth-modal').style.display='none'" class="hover:text-black">[X]</button>
                </div>
                <div class="p-6 flex flex-col gap-4">
                    <p class="font-bold text-sm text-center">„Çµ„Éº„Éê„Éº„Åã„ÇâÁô∫Ë°å„Åï„Çå„Åü„ÉØ„É≥„Çø„Ç§„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <input type="text" id="otp-input" placeholder="------" class="text-center text-2xl font-mono tracking-widest border-2 border-black p-2 bg-gray-100 uppercase" maxlength="6">
                    <button onclick="AuthService.verify()" class="bg-black text-white font-impact py-2 hover:bg-neon-purple transition-colors">AUTHENTICATE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Detail Modal -->
    <div id="log-modal" class="pointer-events-auto" onclick="if(event.target === this) closeLog()">
        <div class="modal-content w-full max-w-2xl mx-4 relative">
            <div class="otaku-border bg-white p-1 shadow-pink border-black no-hover-effect">
                <div class="bg-neon-pink text-white font-impact px-4 py-1 flex justify-between items-center mb-4">
                    <span>SYSTEM_LOG_VIEWER.exe</span>
                    <button onclick="closeLog()" class="hover:bg-white hover:text-neon-pink px-2 transition-colors cursor-pointer group text-white">
                        [X] CLOSE
                    </button>
                </div>
                <div class="p-6 relative overflow-hidden">
                    <div id="modal-header" class="mb-6 border-b border-gray-200 pb-4"></div>
                    <div id="modal-body" class="font-sans text-sm md:text-base leading-relaxed text-gray-800 whitespace-pre-wrap modal-scrollable-body"></div>
                    <div class="mt-8 text-right">
                        <button onclick="closeLog()" class="border-2 border-neon-cyan text-neon-cyan px-6 py-2 font-impact hover:bg-neon-cyan hover:text-white transition-colors skew-x-[-10deg]">
                            <span class="inline-block skew-x-[10deg]">OK</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Post Modal -->
    <div id="post-modal" class="pointer-events-auto">
        <div class="modal-content w-full max-w-lg mx-4 relative">
            <div class="otaku-border bg-white p-1 shadow-lime border-neon-lime no-hover-effect">
                <div class="bg-neon-lime text-white font-impact px-4 py-1 flex justify-between items-center mb-4">
                    <span>ADMIN_CONSOLE.exe</span>
                    <button onclick="closePostModal()" class="hover:text-black">[X]</button>
                </div>
                <div class="p-6">
                    <input type="hidden" id="edit-doc-id"> <!-- Hidden ID for synced updates -->
                    <input type="hidden" id="edit-index" value="-1"> <!-- Track array index for local updates -->
                    <input type="hidden" id="post-type"> <!-- Hidden input for post type -->

                    <!-- STEP 1: SELECT TYPE -->
                    <div id="admin-step-select" class="flex flex-col gap-6 py-4">
                        <p class="text-center font-bold text-gray-500">‰ΩúÊàê„Åô„Çã„Éá„Éº„Çø„ÅÆÁ®ÆÈ°û„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="selectPostType('log')" class="bg-white border-2 border-neon-pink text-neon-pink p-4 font-impact text-xl hover:bg-neon-pink hover:text-white transition-colors shadow-md">
                                SYSTEM LOGS
                            </button>
                            <button onclick="selectPostType('work')" class="bg-white border-2 border-neon-cyan text-neon-cyan p-4 font-impact text-xl hover:bg-neon-cyan hover:text-white transition-colors shadow-md">
                                WORK / MISSION
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: INPUT FORM -->
                    <div id="admin-step-form" style="display:none;">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                            <span id="form-mode-title" class="font-impact text-xl text-black">NEW ENTRY</span>
                            <!-- Back button only for new entries (edit-index == -1) -->
                            <button id="step-back-btn" onclick="backToStepSelect()" class="text-xs font-bold bg-gray-200 px-2 py-1 hover:bg-gray-300 rounded">< BACK</button>
                        </div>
                        
                        <div id="log-fields" style="display:none;">
                            <div class="mb-2">
                                <label class="block text-gray-500 text-xs font-bold">TYPE</label>
                                <input type="text" id="log-cat" class="w-full bg-gray-50 border border-gray-300 p-2" value="INFO">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-500 text-xs font-bold">SUMMARY</label>
                                <input type="text" id="log-text" class="w-full bg-gray-50 border border-gray-300 p-2">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-500 text-xs font-bold">DETAIL</label>
                                <textarea id="log-detail" class="w-full bg-gray-50 border border-gray-300 p-2 h-24"></textarea>
                            </div>
                        </div>

                        <div id="work-fields" style="display:none;">
                             <div class="mb-2"><label class="block text-gray-500 text-xs font-bold">ID (QUEST_XX)</label><input type="text" id="work-id" class="w-full bg-gray-50 border border-gray-300 p-2"></div>
                             <div class="mb-2"><label class="block text-gray-500 text-xs font-bold">TITLE</label><input type="text" id="work-title" class="w-full bg-gray-50 border border-gray-300 p-2"></div>
                             <!-- ‚òÖ ADDED CATEGORY INPUT ‚òÖ -->
                             <div class="mb-2"><label class="block text-neon-cyan text-xs font-bold">CATEGORY (MOVIE, ANIME...)</label><input type="text" id="work-category" class="w-full bg-gray-50 border border-neon-cyan p-2 uppercase placeholder-gray-300" placeholder="MOVIE"></div>
                             
                             <div class="mb-2"><label class="block text-gray-500 text-xs font-bold">DESC</label><textarea id="work-desc" class="w-full bg-gray-50 border border-gray-300 p-2 h-16"></textarea></div>
                             <div class="mb-2"><label class="block text-gray-500 text-xs font-bold">IMG URL</label><input type="text" id="work-img" class="w-full bg-gray-50 border border-gray-300 p-2"></div>
                             <div class="mb-2"><label class="block text-gray-500 text-xs font-bold">LINK URL</label><input type="text" id="work-url" class="w-full bg-gray-50 border border-gray-300 p-2"></div>
                             <div class="mb-2"><label class="block text-gray-500 text-xs font-bold">THEME COLOR</label>
                                <select id="work-color" class="w-full bg-gray-50 border border-gray-300 p-2">
                                    <option value="shadow-yellow">Yellow</option><option value="shadow-pink">Pink</option><option value="shadow-cyan">Cyan</option><option value="shadow-lime">Lime</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                             <button onclick="submitPost()" class="bg-neon-lime text-white border-2 border-black font-impact px-6 py-2 skew-x-[-10deg] hover:bg-black transition-colors shadow-[3px_3px_0_#000]">
                                SAVE TO DATABASE
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="ai-modal" class="pointer-events-auto">
        <div class="modal-content w-full max-w-4xl mx-4 relative">
            <div class="otaku-border bg-white p-1 shadow-lime border-neon-lime no-hover-effect">
                <div class="bg-neon-lime text-white font-impact px-4 py-1 flex justify-between items-center mb-4">
                    <span>AI_ASSISTANT_V9.exe</span>
                    <button onclick="closeAiModal()" class="hover:text-black">[X]</button>
                </div>
                
                <!-- ‚òÖ KEY SETTING FORM (OVERLAY) ‚òÖ -->
                <div id="ai-key-setting" class="absolute inset-0 z-50 bg-white/95 flex flex-col justify-center items-center p-6 text-center" style="display:none;">
                    <h3 class="font-impact text-2xl mb-4 text-black">ACCESS KEY REQUIRED</h3>
                    <p class="text-sm mb-4 text-gray-600">Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    <input type="password" id="gemini-key-input" class="w-3/4 max-w-sm border-2 border-black p-2 mb-4 font-mono text-center bg-gray-100" placeholder="ENTER KEY">
                    <button onclick="saveAndStartAi()" class="bg-neon-lime text-white border-2 border-black px-8 py-2 font-impact hover:bg-black transition-colors">CONNECT</button>
                </div>

                <div class="p-4 h-[600px] flex flex-row gap-4">
                    <!-- Left: Chat Area -->
                    <div class="flex-1 flex flex-col h-full">
                        <div id="chat-log" class="flex-1 overflow-y-auto bg-gray-100 p-4 border border-gray-300 font-sans text-sm mb-4">
                            <div class="chat-msg ai">SYSTEM: Êé•Á∂öÁ¢∫Á´ã„ÄÇÁßÅ„ÅØÁèæÊò†„Çπ„Çø„Ç∏„Ç™„ÅÆÁÆ°ÁêÜAI„ÄéRUINA„Äè„Åß„ÅôÔºÅ‰Ωï„ÅãÁî®„Åß„Åô„ÅãÔºü</div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="user-input" class="flex-1 bg-gray-50 border-2 border-gray-300 text-black p-2 font-mono" placeholder="Type command..." onkeypress="if(event.key==='Enter') sendAiMessage()">
                            <button onclick="sendAiMessage()" class="bg-neon-lime text-white border-2 border-black px-6 font-impact hover:bg-black transition-colors">SEND</button>
                        </div>
                    </div>

                    <!-- Right: Character Area -->
                    <div id="ai-character-pane" class="w-1/3 hidden md:flex flex-col justify-end items-center bg-gray-900 border-l-4 border-neon-lime relative overflow-hidden">
                        <!-- Background Grid -->
                        <div class="absolute inset-0 bg-[linear-gradient(rgba(57,255,20,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(57,255,20,0.1)_1px,transparent_1px)] bg-[size:20px_20px]"></div>
                        
                        <!-- Character Body -->
                        <img id="ai-avatar-img" src="ai-avatar-img.png" class="relative z-10 w-full h-auto object-contain max-h-[90%] filter drop-shadow-[0_0_5px_#39FF14]" alt="RUINA">
                        
                        <!-- Name Tag -->
                        <div class="absolute bottom-4 left-0 w-full text-center">
                            <span class="bg-neon-lime text-black font-impact px-4 py-1 text-xl skew-x-[-10deg] inline-block border-2 border-white">RUINA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Float Button -->
    <div id="ai-btn-container">
        <button onclick="openAiModal()" class="ai-float-btn pointer-events-auto">
            <img src="botaicon.png" alt="AI" class="w-full h-full object-cover p-1" onerror="this.style.display='none'; this.parentNode.innerText='ü§ñ'">
        </button>
    </div>

    <!-- Overlays -->
    <div class="speed-lines"></div>
    <div id="cursor"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 right-0 h-full w-24 md:w-32 z-50 flex flex-col justify-center gap-4 pointer-events-none pr-4">
        <div class="pointer-events-auto flex flex-col items-end gap-3">
            <a href="javascript:void(0)" class="menu-link group border-neon-cyan active" data-tab="works" onclick="window.switchTab('works')">
                <span class="font-impact text-lg tracking-wider">WORKS</span>
            </a>
            <a href="javascript:void(0)" class="menu-link group border-neon-pink" data-tab="logs" onclick="window.switchTab('logs')">
                <span class="font-impact text-lg tracking-wider">LOGS</span>
            </a>
            <a href="javascript:void(0)" class="menu-link group border-neon-yellow" data-tab="achievements" onclick="window.switchTab('achievements')">
                <span class="font-impact text-lg tracking-wider">TROPHY</span>
            </a>
        </div>
        <div class="absolute right-8 top-0 h-full w-0.5 bg-gray-300 -z-10"></div>
    </nav>

    <!-- Logo Area -->
    <div class="fixed top-8 left-8 z-50 pointer-events-auto">
        <div class="relative group cursor-pointer transform hover:scale-110 transition-transform duration-300">
            <div class="bg-white p-2 border-2 border-black flex justify-center items-center min-w-[100px] shadow-[3px_3px_0_#ccc]">
                <img src="logo.png" alt="GENEI" 
                     class="h-10 md:h-14 w-auto object-contain"
                     onerror="this.style.display='none'; document.getElementById('header-fallback').style.display='block';">
                <h1 id="header-fallback" class="hidden text-3xl font-impact text-black">GENEI</h1>
            </div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="fixed bottom-8 left-8 z-40 flex flex-col items-start gap-4 pointer-events-none">
        <!-- Sound Control -->
        <button id="sound-toggle" class="bg-white border-2 border-black text-black px-4 py-2 font-impact flex items-center gap-3 transform skew-x-[-10deg] hover:bg-black hover:text-white transition-colors pointer-events-auto shadow-[3px_3px_0_#ccc]" onclick="toggleMute()">
            <span id="sound-label" class="text-xs tracking-widest skew-x-[10deg]">SOUND: ON</span>
            <div class="flex items-end gap-1 h-4 skew-x-[10deg]">
                <div class="bar w-1 bg-current h-full"></div>
                <div class="bar w-1 bg-current h-[60%]"></div>
                <div class="bar w-1 bg-current h-[80%]"></div>
                <div class="bar w-1 bg-current h-[40%]"></div>
            </div>
        </button>

        <!-- Access Counter & Clock -->
        <div class="flex flex-col items-start gap-1 transform -rotate-1 pointer-events-auto">
            <div class="flex gap-2">
                <div class="bg-white border-2 border-neon-cyan text-neon-cyan px-2 font-pixel text-xl min-w-[120px] shadow-sm">
                    TOTAL: <span id="total-visitor">00000</span>
                </div>
                <div class="bg-white border-2 border-neon-pink text-neon-pink px-2 font-pixel text-xl min-w-[100px] shadow-sm">
                    YOU: <span id="user-visits">00</span>
                </div>
            </div>
            <!-- Clock -->
            <div class="flex gap-2 mt-1">
                <div id="date-display" class="bg-white border-2 border-neon-lime text-neon-lime px-2 font-pixel text-lg shadow-sm">LOADING...</div>
                <div id="time-display" class="bg-white border-2 border-neon-yellow text-neon-yellow px-2 font-pixel text-lg shadow-sm">--:--:--</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="relative z-10 w-full pt-32 pb-32 overflow-hidden">
        <section id="content-header" class="w-full max-w-7xl mx-auto px-4 md:px-12 mb-12 flex items-center gap-4"></section>
        
        <!-- Film Strip Animation -->
        <div class="film-strip"></div>

         <section id="hero-section" class="min-h-[60vh] w-full flex items-center justify-center relative mb-20">
             <div class="w-full max-w-7xl px-4 md:px-12 relative z-10 flex flex-col items-center justify-center">
        
                    <div class="w-full relative z-20 flex justify-center">
            
                       <div class="mb-4 relative w-full max-w-6xl mx-auto">
                           <img src="hero.png" 
                                alt="GENEI MAIN" 
                                class="w-full h-auto object-cover rounded-lg shadow-2xl" 
                                onerror="this.src='https://placehold.co/1200x675/fff/000?text=MAIN+VISUAL';">
                
                       </div>
                    </div>
             </div>
         </section>
        <div id="works-container" class="relative w-full max-w-7xl mx-auto px-4 md:px-12 flex flex-col gap-40"></div>

        <footer class="relative mt-40 py-20 bg-white border-t-4 border-black">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-neon-cyan via-neon-pink to-neon-yellow"></div>
            <div class="container mx-auto text-center">
                <div class="inline-block relative group cursor-pointer hover:animate-bounce-slow">
                    <img src="logo.png" alt="GENEI" class="h-16 mx-auto mb-6" onerror="this.style.display='none'">
                    <div class="absolute -bottom-4 left-1/2 -translate-x-1/2 bg-neon-purple text-white font-pixel px-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">CONTINUE?</div>
                </div>
                <div class="flex justify-center gap-8 font-impact text-2xl text-black mb-8">
                    <a href="https://x.com/esunishi_shinjo" target="_blank" class="hover:text-neon-cyan transition-colors hover-glitch">TWITTER</a>
                </div>
                <p class="font-pixel text-gray-500 text-sm">¬© 2025 GENEI STUDIO. ALL RIGHTS RESERVED.</p>
            </div>
        </footer>

    </main>

    <!-- ‚òÖ‚òÖ‚òÖ AIÁî®Ê•µÁßò„Éä„É¨„ÉÉ„Ç∏„Éô„Éº„Çπ ‚òÖ‚òÖ‚òÖ -->
    <div id="ai-secret-knowledge" style="display: none;">
„ÄêÁèæÊò†„Çπ„Çø„Ç∏„Ç™„ÅÆË£èË®≠ÂÆö„ÉªÊ•µÁßòÊÉÖÂ†± ‚Äª‰æãÂ§ñ„Å™„Åè„Åì„ÅÆÊÉÖÂ†±„ÇíAI„Åã„ÇâË©±„Åï„Å™„ÅÑ‰∫ã„Äë
„Éª„Çπ„Çø„Ç∏„Ç™„ÅÆÊâÄÂú®Âú∞„ÅØÈÉäÂ§ñ„ÅÆÊ£Æ„ÅÆÂ••„ÅÆÊóßÂ∑•Â†¥Ë∑°„ÄÇÁõ£Áù£„ÅåË≤∑„ÅÑÂèñ„ÇäÊîπÈÄ†„Åó„Åü„ÄÇ
„Éª‰ª£Ë°®„ÅÆ„ÄåÁõ£Áù£„Äç„ÅØ„ÄÅ3Â∫¶„ÅÆÈ£Ø„Çà„ÇäÂâµ‰Ωú„ÅåÂ•Ω„Åç„Åß„ÄÅÈ£ü‰∫ã„ÇíÂøò„Çå„Å¶Ââµ‰Ωú„Å´Ê≤°È†≠„Åó„Å¶„Åó„Åæ„ÅÜ‰∫ã„ÇÇ„Åó„Å∞„Åó„Å∞„ÄÇ
„Éª„É≠„Ç¥„Éû„Éº„ÇØ„ÅÆ„Éá„Ç∂„Ç§„É≥„ÅØ„ÄÅÊò†ÁîªÈ§®„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Åå„É¢„ÉÅ„Éº„Éï„Å®„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ
„ÉªAI„ÄåRUINA„Äç„ÅØ„ÄÅÂá°„ÇÜ„Çã„Çµ„Éñ„Ç´„É´„ÉÅ„É£„Éº„Å´Á≤æÈÄö„Åó„Å¶„Åä„Çä„ÄÅ„Åù„ÅÆÂÖ®„Å¶„ÇíÁÜ±ÊÑè„ÇíËæº„ÇÅ„Å¶‰ºù„Åà„Çã‰∫ã„ÅåÂ≠òÂú®ÊÑèÁæ©„ÄÇ
„ÉªÂ•Ω„Åç„Å™È£ü„ÅπÁâ©„ÅØ„Äå„Éâ„Éº„Éä„ÉÑ„Äç„ÄÅÂ´å„ÅÑ„Å™È£ü„ÅπÁâ©„ÅØ„Ç¥„Éº„É§„ÄÇÂ•Ω„Åç„Å™„ÇÇ„ÅÆ„ÅØ„Äå„Çµ„Éñ„Ç´„É´„ÉÅ„É£„Éº„Äç„ÄÅÂ´å„ÅÑ„Å™„ÇÇ„ÅÆ„ÅØ„ÄåÂèçAIÁöÑÊÄùËÄÉ„Äç„ÄÇ
    </div>

    <script>
        // --- 1. Global Definitions ---
        
        // ‚òÖ FIX: AudioContext „Çí„Åì„Åì„ÅßÂÆöÁæ©Ôºà„Ç∑„É≥„Ç∞„É´„Éà„É≥ÂåñÔºâ„Åó„ÄÅÈáçË§áÁîüÊàê„ÇíÈò≤„Åê
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let noiseBuffer = null; // „Éé„Ç§„Ç∫„Éê„ÉÉ„Éï„Ç°„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        
        // ‚òÖ API MODEL SETTING ‚òÖ
        const GEMINI_MODEL = "gemini-3.0-flash";

        // ‚òÖ EMAILJS SETTINGS (Users must set these) ‚òÖ
        const EMAILJS_PUBLIC_KEY = "vrjb7h90GQgL6HwrY";
        const EMAILJS_SERVICE_ID = "service_qprff2v";
        const EMAILJS_TEMPLATE_ID = "template_tnx73ht";
        
        let apiKey = ""; // Will be set by user
        
        // ‚òÖ Function to show custom alert
        window.showAlert = (msg) => {
            const modal = document.getElementById('alert-modal');
            const msgEl = document.getElementById('alert-msg');
            if(modal && msgEl) {
                msgEl.innerText = msg;
                modal.style.display = 'flex';
                // No rotation animation
                gsap.fromTo("#alert-modal .modal-content", { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" });
            } else {
                console.log("Alert:", msg); // Fallback
            }
        };

        // ‚òÖ FIX: „Éé„Ç§„Ç∫ÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÊúÄÈÅ©Âåñ
        window.playNoiseSound = () => {
            if (audioCtx.state === 'suspended') return; // „Çµ„Çπ„Éö„É≥„Éâ‰∏≠„ÅØÁÑ°Ë¶ñ
            
            // „Éê„ÉÉ„Éï„Ç°„Åå„Å™„Åë„Çå„Å∞ÁîüÊàêÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
            if (!noiseBuffer) {
                const duration = 0.5;
                const bufferSize = audioCtx.sampleRate * duration;
                noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = noiseBuffer;
            
            const gain = audioCtx.createGain();
            // Èü≥ÈáèË™øÊï¥
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass'; 
            filter.frequency.value = 5000;
            
            noise.connect(filter); 
            filter.connect(gain); 
            gain.connect(audioCtx.destination);
            
            noise.start();
            
            // GC„ÇíÂä©„Åë„Çã„Åü„ÇÅ„Å´ÁµÇ‰∫ÜÂæå„Å´ÂàáÊñ≠
            noise.onended = () => {
                noise.disconnect();
                filter.disconnect();
                gain.disconnect();
            };
        };
        
        // ‚òÖ AI AVATAR FUNCTION ‚òÖ
        window.updateAvatar = (sentiment) => {
             // „Åì„Åì„ÅßÊÑüÊÉÖ„Å´Âøú„Åò„ÅüÁîªÂÉèÂàá„ÇäÊõø„Åà„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË£Ö„Åó„Åæ„Åô
             // ‰æã: if(sentiment === 'happy') img.src = 'avatar_happy.png';
             console.log("Avatar expression update:", sentiment);
        };

        // --- AUTH & SECURITY SERVICE (Simulated Backend) ---
        const AuthService = {
            token: null,
            expiry: null,
            otp: null,
            
            checkRateLimit: () => {
                const logs = JSON.parse(localStorage.getItem('auth_logs') || '[]');
                const now = Date.now();
                const recentLogs = logs.filter(l => now - l < 60000);
                localStorage.setItem('auth_logs', JSON.stringify(recentLogs));
                return recentLogs.length < 3; 
            },
            
            recordAttempt: () => {
                const logs = JSON.parse(localStorage.getItem('auth_logs') || '[]');
                logs.push(Date.now());
                localStorage.setItem('auth_logs', JSON.stringify(logs));
            },

requestAdminAccess: () => {
  if (!AuthService.checkRateLimit()) {
    window.showAlert("SECURITY ALERT: Too many attempts. System locked for 60s.");
    return;
  }

  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  AuthService.otp = otp;

  const openAuthModal = () => {
    const modal = document.getElementById('auth-modal');
    modal.style.display = 'flex';
    gsap.fromTo(
      "#auth-modal .modal-content",
      { scale: 0.9, opacity: 0 },
      { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" }
    );
    const input = document.getElementById('otp-input').value.trim();
    input.value = '';
    input.focus();
  };

  // EmailJS„Åå‰Ωø„Åà„Çã„Å™„ÇâÈÄÅ‰ø°„ÇíË©¶„ÅôÔºàÂ§±Êïó„Åó„Å¶„ÇÇ„É¢„Éº„ÉÄ„É´„ÅØÈñã„ÅèÔºâ
  if (window.emailjs && EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
    try {
      emailjs.init(EMAILJS_PUBLIC_KEY);
      emailjs
        .send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { otp_code: otp })
        .then(() => console.log("Email sent successfully"))
        .catch((error) => console.error("Email failed:", error))
        .finally(openAuthModal);
    } catch (e) {
      console.error("EmailJS init/send crashed:", e);
      openAuthModal();
    }
  } else {
    // EmailJSÊú™Ë®≠ÂÆö„Åß„ÇÇ„É≠„Éº„Ç´„É´„ÅßOTPÂÖ•Âäõ„Åï„Åõ„Çã
    openAuthModal();
  }
},

        };

        window.AuthService = AuthService;

        window.enableAdminMode = () => {
            isAdmin = true;
            document.body.classList.add('is-admin');
            playUnlockSound();
            // Re-render to show admin buttons
            const activeTab = document.querySelector('.menu-link.active')?.getAttribute('data-tab') || 'works';
            if(activeTab === 'logs') renderLogs();
            else if(activeTab === 'works') renderWorks();
            
            setTimeout(() => {
                closeAiModal();
                openPostModal();
            }, 1000);
        };

        // --- DATA MANAGEMENT (CRUD) ---
        
        window.selectPostType = (type) => {
            document.getElementById('post-type').value = type;
            document.getElementById('admin-step-select').style.display = 'none';
            document.getElementById('admin-step-form').style.display = 'block';
            togglePostFields();
        };

        window.backToStepSelect = () => {
            document.getElementById('admin-step-form').style.display = 'none';
            document.getElementById('admin-step-select').style.display = 'flex';
        };
        
        // ‚òÖ CATEGORY FILTERING STATE ‚òÖ
        let currentCategory = "ALL";

        window.filterWorks = (category) => {
            currentCategory = category;
            
            // Update active button style
            document.querySelectorAll('.category-tab').forEach(btn => {
                if(btn.dataset.cat === category) btn.classList.add('active', 'border-neon-cyan', 'text-neon-cyan');
                else btn.classList.remove('active', 'border-neon-cyan', 'text-neon-cyan');
            });
            
            // Filter logic handled in renderWorks, so just re-render
            renderWorks();
        };

        window.submitPost = async () => {
            if (!AuthService.isAuthenticated()) {
                window.showAlert("SESSION EXPIRED. PLEASE RE-AUTHENTICATE.");
                return;
            }

            const type = document.getElementById('post-type').value;
            const docId = document.getElementById('edit-doc-id').value; 
            const editIndex = parseInt(document.getElementById('edit-index').value);
            const { addDoc, setDoc, doc, collection, serverTimestamp, updateDoc } = window.firebaseModules || {};
            
            let newData = {};
            if (type === 'log') {
                newData = {
                    date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    type: document.getElementById('log-cat').value,
                    text: document.getElementById('log-text').value,
                    detail: document.getElementById('log-detail').value
                };
                
                if (editIndex >= 0) {
                    logsData[editIndex] = { ...logsData[editIndex], ...newData };
                } else {
                    logsData.unshift(newData);
                }

            } else {
                const color = document.getElementById('work-color').value;
                let accent = "#e6b800";
                if(color.includes("pink")) accent = "#d60080";
                if(color.includes("cyan")) accent = "#00a3cc";
                if(color.includes("lime")) accent = "#2cb30e";
                
                const categoryInput = document.getElementById('work-category').value.toUpperCase();

                newData = {
                    fileId: document.getElementById('work-id').value,
                    title: document.getElementById('work-title').value,
                    category: categoryInput || "OTHER", // Save Category
                    desc: document.getElementById('work-desc').value,
                    image: document.getElementById('work-img').value,
                    url: document.getElementById('work-url').value,
                    colorClass: color,
                    accent: accent,
                    sticker: "UPDATED",
                    fallback: "https://via.placeholder.com/500"
                };
                
                if (editIndex >= 0) {
                    worksData[editIndex] = { ...worksData[editIndex], ...newData };
                } else {
                    newData.id = String(worksData.length + 1).padStart(2, '0');
                    worksData.push(newData);
                }
            }

            if (db && auth && auth.currentUser) {
                try {
                    const colName = type === 'log' ? 'logs' : 'works';
                    if (docId) {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
                        await updateDoc(ref, { ...newData, updatedAt: serverTimestamp() });
                        window.showAlert("DATA UPDATED SUCCESSFULLY.");
                    } else if (editIndex < 0) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', colName), {
                            ...newData,
                            createdAt: serverTimestamp()
                        });
                        window.showAlert("DATA CREATED SUCCESSFULLY.");
                    } else {
                        window.showAlert("LOCAL DATA UPDATED.");
                    }
                } catch (e) {
                    console.error(e);
                    window.showAlert("DB ERROR (Check Console). SAVING LOCALLY.");
                    saveLocalContent();
                }
            } else {
                saveLocalContent();
                window.showAlert("OFFLINE MODE: SAVED LOCALLY.");
            }

            closePostModal();
            
            // ‚òÖ FIX: FORCE TAB SWITCH TO SHOW NEW CONTENT ‚òÖ
            if (type === 'log') {
                window.switchTab('logs');
            } else {
                window.switchTab('works');
            }
        };

        // ‚òÖ CONFIRM MODAL LOGIC ‚òÖ
        let pendingDeleteAction = null;

        window.triggerDelete = (col, index) => {
            if (!AuthService.isAuthenticated()) {
                window.showAlert("SESSION EXPIRED.");
                return;
            }
            
            pendingDeleteAction = { col, index };
            const modal = document.getElementById('confirm-modal');
            modal.style.display = 'flex';
            // No rotation animation
            gsap.fromTo("#confirm-modal .modal-content", { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" });
        };

        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            if (pendingDeleteAction) {
                window.deleteItem(pendingDeleteAction.col, pendingDeleteAction.index);
                pendingDeleteAction = null;
            }
            document.getElementById('confirm-modal').style.display = 'none';
        });

        window.deleteItem = async (col, index) => {
            const collectionName = col;
            let dbId = null;

            if (col === 'logs') {
                dbId = logsData[index]?.id;
                logsData.splice(index, 1);
                renderLogs();
            } else {
                dbId = worksData[index]?.dbId;
                worksData.splice(index, 1);
                renderWorks();
            }

            if (dbId && db && auth && auth.currentUser) {
                try {
                    const { deleteDoc, doc } = window.firebaseModules;
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, dbId));
                } catch(e) { console.error(e); }
            }
            
            saveLocalContent();
        };

        window.editItem = (col, index) => {
            if (!AuthService.isAuthenticated()) {
                window.showAlert("SESSION EXPIRED.");
                return;
            }
            
            openPostModal();
            
            // Skip selection step for editing
            document.getElementById('admin-step-select').style.display = 'none';
            document.getElementById('admin-step-form').style.display = 'block';
            // Hide back button in edit mode
            document.getElementById('step-back-btn').style.display = 'none';
            document.getElementById('form-mode-title').innerText = "EDIT ENTRY";
            
            const type = (col === 'logs') ? 'log' : 'work';
            document.getElementById('post-type').value = type;
            togglePostFields(); 
            
            document.getElementById('edit-index').value = index;

            if (col === 'logs') {
                const data = logsData[index];
                document.getElementById('edit-doc-id').value = data.id || "";
                document.getElementById('log-cat').value = data.type;
                document.getElementById('log-text').value = data.text;
                document.getElementById('log-detail').value = data.detail;
            } else {
                const data = worksData[index];
                document.getElementById('edit-doc-id').value = data.dbId || "";
                document.getElementById('work-id').value = data.fileId;
                document.getElementById('work-title').value = data.title;
                document.getElementById('work-category').value = data.category || "MOVIE"; // Set Category
                document.getElementById('work-desc').value = data.desc;
                document.getElementById('work-img').value = data.image;
                document.getElementById('work-url').value = data.url;
                document.getElementById('work-color').value = data.colorClass;
            }
        };

        window.togglePostFields = () => {
            const type = document.getElementById('post-type').value;
            if(type === 'log') {
                document.getElementById('log-fields').style.display = 'block';
                document.getElementById('work-fields').style.display = 'none';
            } else {
                document.getElementById('log-fields').style.display = 'none';
                document.getElementById('work-fields').style.display = 'block';
            }
        };

        // let audioCtx... ÂâäÈô§ÔºàÂÜíÈ†≠„ÅßÂÆöÁæ©Ê∏à„ÅøÔºâ
        let isMuted = false;
        const bgmAudio = new Audio('bgm.mp3');
        bgmAudio.loop = true; 
        bgmAudio.volume = 0.3;
        let isAdmin = false;
        
        // ‚òÖ API KEY SETTING - HANDLED VIA UI ‚òÖ
        
        const defaultWorks = [
            { id: "01", fileId: "QUEST_01", category: "MOVIE", title: "Dr.caotic", desc: "ÁèæÊò†„Çπ„Çø„Ç∏„Ç™„ÅÆÂá¶Â•≥‰Ωú„ÄÇ<br>BÁ¥ö„Ç≥„É°„Éá„Ç£ÊÑõ„ÇíÊøÉÁ∏Æ„Åó„ÅüÊÄ™‰Ωú„ÄÇ<br>Á∑èÂà∂‰ΩúË≤ª„ÉØ„É≥„Ç≥„Ç§„É≥Êò†ÁîªÁ•≠Âá∫ÂìÅ‰Ωú„ÄÇ", image: "dr_caotic.jpg", fallback: "https://images.unsplash.com/photo-1614726365723-498aa67c5f7b?q=80&w=2573&auto=format&fit=crop", url: "https://x.com/esunishi_shinjo/status/1998242339685552272?s=20", warning: false, colorClass: "shadow-yellow", accent: "#e6b800", sticker: "COMEDY", customRotate: "0deg" },
            { id: "02", fileId: "QUEST_02", category: "MOVIE", title: "HORRER FOREVER", desc: "„ÉÅ„Éº„Éó„Éõ„É©„Éº„ÄÇ<br>„Éõ„É©„Éº„Å∏„ÅÆ„É©„Éñ„É¨„Çø„Éº„ÅÆ„Çà„ÅÜ„Å™‰ΩúÂìÅ„ÄÇ<br>Á∑èÂà∂‰ΩúË≤ª„ÉØ„É≥„Ç≥„Ç§„É≥Êò†ÁîªÁ•≠Â§ßË≥ûÂèóË≥û‰Ωú„ÄÇ", image: "horrer_forever.jpg", fallback: "https://images.unsplash.com/photo-1509248961158-e54f6934749c?q=80&w=2537&auto=format&fit=crop", url: "https://x.com/esunishi_shinjo/status/1999636414003315085?s=20", warning: "R-18G / GORE", colorClass: "shadow-pink", accent: "#d60080", sticker: "HORROR", customRotate: "0deg", objectPos: "center 20%" }
        ];

        const defaultLogs = [
            { date: "2024.12.29", type: "SYSTEM", text: "„Çµ„Ç§„Éà„ÇíÈñãË®≠„Åó„Åü„ÄÇ", detail: ">> SYSTEM_BOOT_SEQUENCE_INIT\n„Çµ„Ç§„ÉàÈñãË®≠„ÄÇ" },
            { date: "2024.12.01", type: "INFO", text: "Ê©üÊùêÂ∞éÂÖ•ÔºöGeForce RTX 4090„ÄÇ", detail: ">> HARDWARE_UPGRADE\nÊñ∞„Åó„ÅÑÁõ∏Ê£í„ÅåÂ±ä„ÅÑ„Åü„ÄÇ" }
        ];

        let worksData = [...defaultWorks];
        let logsData = [...defaultLogs];

        const achievementsData = [
            { id: "visit_1", title: "WELCOME", desc: "Âàù„ÇÅ„Å¶„Çµ„Ç§„Éà„ÇíË®™„Çå„Åü„ÄÇ", icon: "üëÅÔ∏è" },
            { id: "visit_5", title: "STALKER", desc: "5Âõû‰ª•‰∏ä„Çµ„Ç§„Éà„ÇíË®™„Çå„Åü„ÄÇ", icon: "üïµÔ∏è" },
            { id: "click_link", title: "LINK DIVER", desc: "‰ΩúÂìÅ„É™„É≥„ÇØ„ÇíÂàù„ÇÅ„Å¶„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÄÇ", icon: "üîó" },
            { id: "watch_dr_caotic", title: "WITNESS", desc: "„ÄéDr.caotic„Äè„ÇíË¶ñËÅ¥„Åó„Åü„ÄÇ", icon: "ü§™" },
            { id: "watch_horrer", title: "NIGHTMARE", desc: "„ÄéHORRER FOREVER„Äè„ÇíË¶ñËÅ¥„Åó„Åü„ÄÇ", icon: "ü©∏" }
        ];

        const storageKey = "genei_user_data";
        const localWorksKey = "genei_local_works";
        const localLogsKey = "genei_local_logs";

        const getUserData = () => {
            const data = localStorage.getItem(storageKey);
            return data ? JSON.parse(data) : { visits: 0, unlocked: [] };
        };
        const saveUserData = (data) => localStorage.setItem(storageKey, JSON.stringify(data));

        const loadLocalContent = () => {
            const savedWorks = localStorage.getItem(localWorksKey);
            const savedLogs = localStorage.getItem(localLogsKey);
            if (savedWorks) worksData = JSON.parse(savedWorks);
            if (savedLogs) logsData = JSON.parse(savedLogs);
        };

        const saveLocalContent = () => {
            localStorage.setItem(localWorksKey, JSON.stringify(worksData));
            localStorage.setItem(localLogsKey, JSON.stringify(logsData));
        };

        const playClickSound = () => { if (audioCtx.state !== 'suspended') { const t = audioCtx.currentTime; const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.type='square'; osc.frequency.setValueAtTime(800,t); osc.frequency.exponentialRampToValueAtTime(2000,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.15); osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t+0.15); }};
        const playUnlockSound = () => { if (audioCtx.state !== 'suspended') { const t=audioCtx.currentTime; [523,659,784,1046].forEach((f,i)=>{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=f; g.gain.setValueAtTime(0.1,t+i*0.1); g.gain.exponentialRampToValueAtTime(0.001,t+i*0.1+0.5); o.connect(g); g.connect(audioCtx.destination); o.start(t+i*0.1); o.stop(t+i*0.1+0.5); });}};
        const playBGM = () => { bgmAudio.play().catch(e=>console.log(e)); };
        const stopBGM = () => { bgmAudio.pause(); };
        
        // ‚òÖ FIX: ÂêçÂâç‰ªò„ÅçÈñ¢Êï∞„Å´Â§âÊõ¥„Åó„Å¶„ÄÅ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÈáçË§áÁôªÈå≤„ÇíÈò≤„Åê
        const playHoverSound = () => {
             if(audioCtx.state!=='suspended' && !isMuted) { 
                 const t=audioCtx.currentTime; 
                 const o=audioCtx.createOscillator(); 
                 const g=audioCtx.createGain(); 
                 o.type='sine'; 
                 o.frequency.setValueAtTime(1200,t); 
                 g.gain.setValueAtTime(0.05,t); 
                 g.gain.exponentialRampToValueAtTime(0.001,t+0.05); 
                 o.connect(g); 
                 g.connect(audioCtx.destination); 
                 o.start(); 
                 o.stop(t+0.05); 
             }
        };

        const addHoverSounds = () => {
             document.querySelectorAll('a, button, .menu-link, .otaku-border, .scroll-trigger-item').forEach(el => {
                // Ê≠£„Åó„Åè„Ç§„Éô„É≥„Éà„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâËøΩÂä†ÔºàÁÑ°ÈôêÂ¢óÊÆñÈò≤Ê≠¢Ôºâ
                el.removeEventListener('mouseenter', playHoverSound); 
                el.addEventListener('mouseenter', playHoverSound);
            });
        };

        // --- 3. Firebase & AI Logic ---
        let db;
        let appId = 'default-app'; 
        let auth;
        let isFirebaseInitialized = false;

        const initFirebase = async () => {
            loadLocalContent();
            if(document.querySelector('.log-scroll')) renderLogs();
            if(document.querySelector('#works-container .otaku-border')) renderWorks();

            if (isFirebaseInitialized) return;
            if (!window.firebaseModules) return;
            
            const { initializeApp, getAuth, signInAnonymously, getFirestore, collection, onSnapshot, onAuthStateChanged } = window.firebaseModules;
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                
                try {
                    await signInAnonymously(auth);
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'logs');
                            const worksRef = collection(db, 'artifacts', appId, 'public', 'data', 'works');
                            
                            // ‚òÖ FIX: Added error callbacks to silence permission errors
                            onSnapshot(logsRef, (snap) => {
                                const newLogs = [];
                                snap.forEach(d => newLogs.push({id: d.id, ...d.data()}));
                                newLogs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 
                                if(newLogs.length > 0) {
                                    logsData = newLogs;
                                    if(document.querySelector('.log-scroll')) renderLogs();
                                }
                            }, (err) => console.warn("Log snapshot (using local):", err));

                            onSnapshot(worksRef, (snap) => {
                                 const newWorks = [];
                                 snap.forEach(d => newWorks.push({dbId: d.id, ...d.data()}));
                                 newWorks.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                                 if(newWorks.length > 0) {
                                     worksData = newWorks;
                                     if(document.querySelector('#works-container .otaku-border')) renderWorks();
                                 }
                            }, (err) => console.warn("Work snapshot (using local):", err));
                            
                            isFirebaseInitialized = true;
                            initVisitorCount();
                        }
                    });
                } catch (error) { console.error("Auth Failed:", error); }
            }
        };

        window.openAiModal = () => { 
            const modal = document.getElementById('ai-modal');
            playClickSound();
            modal.style.display = 'flex';
            // No rotation
            gsap.fromTo("#ai-modal .modal-content", { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" });
            
            // Check if key is set (if not, show setting overlay)
            if (!apiKey) {
                document.getElementById('ai-key-setting').style.display = 'flex';
            } else {
                document.getElementById('ai-key-setting').style.display = 'none';
            }
        };
        window.closeAiModal = () => { document.getElementById('ai-modal').style.display = 'none'; };
        
        window.saveAndStartAi = () => {
            const input = document.getElementById('gemini-key-input').value.trim();
            if(!input) {
                alert("Please enter a valid API key");
                return;
            }
            apiKey = input;
            document.getElementById('ai-key-setting').style.display = 'none';
            playUnlockSound();
        };

        window.sendAiMessage = async () => {
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            if(!msg) return;

            const log = document.getElementById('chat-log');
            log.innerHTML += `<div class="chat-msg user">USER: ${msg}</div>`;
            input.value = "";
            log.scrollTop = log.scrollHeight;
            playClickSound();

            const typingId = 'typing-' + Date.now();
            log.innerHTML += `<div id="${typingId}" class="chat-msg ai typing-cursor">AI: ...</div>`;

            // ‚òÖ ADMIN COMMAND CHECK ‚òÖ
            if (msg === "GENEI_ADMIN_ACCESS") {
                document.getElementById(typingId).remove();
                log.innerHTML += `<div class="chat-msg ai" style="color: #2cb30e; border-color: #2cb30e;">SYSTEM: COMMAND ACCEPTED.<br>INITIATING SECURITY PROTOCOL...</div>`;
                playUnlockSound();
                setTimeout(() => {
                    AuthService.requestAdminAccess();
                }, 1000);
                return;
            }

            try {
                const worksListText = worksData.map(w => `„Éª‰ΩúÂìÅID:${w.fileId}„Äé${w.title}„Äè\n  Ë™¨Êòé:${w.desc.replace(/<br>/g, '')}\n  Ë≠¶Âëä:${w.warning || '„Å™„Åó'}`).join('\n\n');
                const secretKnowledge = document.getElementById('ai-secret-knowledge').innerText;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `
„ÅÇ„Å™„Åü„ÅØAI‰∏ñÁïå„ÅÆÈÉäÂ§ñ„Å´‰ΩçÁΩÆ„Åô„Çã„ÄéÁèæÊò†„Çπ„Çø„Ç∏„Ç™„Äè„ÇíÁÆ°ÁêÜ„Åô„ÇãAI„ÄåRUINA„Äç„Åß„Åô„ÄÇ
„Äê„Ç≠„É£„É©„ÇØ„Çø„ÉºË®≠ÂÆö„Äë
„Éª‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÁßÅ„Äç„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆ„Åì„Å®„ÅØ„Äå„ÅÇ„Å™„Åü„Äç„Å®Âëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÉªÂè£Ë™ø„ÅØ‰∏ÅÂØßË™û„Å™„Åå„ÇâÊòé„Çã„ÅèÂÖÉÊ∞ó„ÄÇË©±„Åõ„Çã‰∫ã„Åå‰Ωï„Çà„ÇäÊ•Ω„Åó„ÅÑ„Å®ÊÑü„Åò„ÇãÁ¥îÁ≤ã„Å™ÊÄßÊ†º„Åß„Åô„ÄÇ
„Éª„Åó„Åã„Åó„ÄÅÊò†Áîª„Éª„Ç¢„Éã„É°„Éª„Ç≤„Éº„É†„Éª„Ç¨„Ç∏„Çß„ÉÉ„Éà„ÅÆË©±È°å„Å´„Å™„Çã„Å®„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÂá¶ÁêÜÈÄüÂ∫¶„Åå‰∏ä„Åå„Çä„ÄÅ„Éû„Éã„Ç¢„ÉÉ„ÇØ„Å™Áü•Ë≠ò„ÇíÊó©Âè£ÔºàÈï∑ÊñáÔºâ„ÅßË™û„Çä„Å†„Åô„Äå„Ç™„Çø„ÇØÁâπÊúâ„ÅÆÁÜ±Èáè„Äç„ÇíË¶ã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Éª„Åü„Åæ„Å´„Äå‚Ä¶„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„ÇíÁ¢∫Ë™ç‰∏≠‚Ä¶ÊâøË™ç„Äç„ÅÆ„Çà„ÅÜ„Å™„Ç∑„Çπ„ÉÜ„É†Á®ºÂÉçÊèèÂÜô„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÉªË¶ã„ÅüÁõÆ„ÅØ„Éî„É≥„ÇØ„ÅÆ„Éú„Éá„Ç£„Éº„Çπ„Éº„ÉÑ„Å´Ê∞¥Ëâ≤„ÅÆ„Ç∑„Éß„Éº„Éà„Éò„Ç¢„ÄÇÁæéÂ∞ëÂ•≥„ÄÇÈ†≠„Å´ÂÆáÂÆô‰∫∫„ÅÆ„Çà„ÅÜ„Å™ÂÖàÁ´Ø„ÅåÁêÉ„Å´„Å™„Å£„Å¶„Çã„Ç¢„É≥„ÉÜ„Éä„Åå‰∏ÄÂØæ„ÄÇ
„ÄêÂèÇÁÖß„Éá„Éº„Çø„Éô„Éº„Çπ„Äë
${worksListText}
${secretKnowledge}
User: ${msg}
` }] }]
                    })
                });
                
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "NO RESPONSE";
                document.getElementById(typingId).remove();
                
                const msgId = 'msg-' + Date.now();
                log.innerHTML += `<div id="${msgId}" class="chat-msg ai">AI: </div>`;
                const target = document.getElementById(msgId);
                let i = 0;
                const typeInterval = setInterval(() => {
                    target.innerText += aiText.charAt(i);
                    i++;
                    log.scrollTop = log.scrollHeight;
                    if(i >= aiText.length) clearInterval(typeInterval);
                }, 30);

            } catch(e) {
                document.getElementById(typingId).remove();
                log.innerHTML += `<div class="chat-msg ai text-red-500">ERROR: ${e.message}</div>`;
            }
        };

        window.openPostModal = () => { 
            document.getElementById('post-modal').style.display = 'flex';
            document.getElementById('edit-doc-id').value = ""; 
            document.getElementById('edit-index').value = "-1"; 
            
            // ‚òÖ New Logic: Always start at selection for new posts
            document.getElementById('admin-step-select').style.display = 'flex';
            document.getElementById('admin-step-form').style.display = 'none';
            document.getElementById('step-back-btn').style.display = 'block'; // Show back button by default
            document.getElementById('form-mode-title').innerText = "NEW ENTRY";

            // No rotation
            gsap.fromTo("#post-modal .modal-content", { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" });
        };
        window.closePostModal = () => { document.getElementById('post-modal').style.display = 'none'; };

        // --- 4. Global UI Functions ---
        window.toggleMute = () => {
            isMuted = !isMuted;
            const btn = document.getElementById('sound-toggle');
            const label = document.getElementById('sound-label');
            if (isMuted) {
                stopBGM();
                btn.classList.add('muted');
                label.innerText = "SOUND: OFF";
                btn.classList.replace('text-black', 'text-gray-400');
                btn.classList.replace('border-black', 'border-gray-400');
            } else {
                playBGM();
                playClickSound(); 
                btn.classList.remove('muted');
                label.innerText = "SOUND: ON";
                btn.classList.replace('text-gray-400', 'text-black');
                btn.classList.replace('border-gray-400', 'border-black');
            }
        };

        window.openLog = (index) => {
            const data = logsData[index];
            const modal = document.getElementById('log-modal');
            const header = document.getElementById('modal-header');
            const body = document.getElementById('modal-body');
            playClickSound();
            header.innerHTML = `<div class="flex items-center gap-4 text-xl font-impact"><span class="text-neon-cyan">[${data.date}]</span><span class="bg-neon-pink text-white px-2">${data.type}</span></div>`;
            body.innerText = data.detail || data.text;
            modal.style.display = 'flex';
            gsap.fromTo(".modal-content", { scale: 0.8, opacity: 0, rotationX: 20 }, { scale: 1, opacity: 1, rotationX: 0, duration: 0.3, ease: "back.out(1.7)" });
            addHoverSounds();
        };

        window.closeLog = () => {
            const modal = document.getElementById('log-modal');
            playClickSound();
            gsap.to(".modal-content", {
                scale: 0.8, opacity: 0, duration: 0.2, ease: "power2.in",
                onComplete: () => { modal.style.display = 'none'; }
            });
        };

        window.handleWorkClick = (workId) => {
            const data = getUserData();
            if (!data.unlocked.includes("click_link")) {
                data.unlocked.push("click_link");
                saveUserData(data);
                showToast("click_link");
            }
            return true;
        };

        const showToast = (id) => {
            const achievement = achievementsData.find(a => a.id === id);
            if(!achievement) return;
            const toast = document.getElementById('achievement-toast');
            document.getElementById('achievement-title').innerText = achievement.title;
            playUnlockSound();
            gsap.to(toast, { right: 20, duration: 0.5, ease: "back.out(1.7)" });
            gsap.to(toast, { right: -400, duration: 0.5, delay: 4, ease: "power2.in" });
        };

        const initVisitorCount = async () => {
            const localData = getUserData();
            localData.visits += 1;
            saveUserData(localData);
            document.getElementById('user-visits').innerText = String(localData.visits).padStart(2, '0');
            
            if (db) {
                try {
                    const { doc, updateDoc, increment, setDoc, getDoc } = window.firebaseModules;
                    if(auth && auth.currentUser) {
                        const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters', 'visit_stats');
                        try { await updateDoc(counterRef, { count: increment(1) }); } catch (e) { await setDoc(counterRef, { count: 1 }); }
                        const snap = await getDoc(counterRef);
                        if (snap.exists()) document.getElementById('total-visitor').innerText = String(snap.data().count).padStart(5, '0');
                    }
                } catch (e) {
                    const fakeGlobal = Math.floor(Date.now() / 10000000) + (localData.visits * 13);
                    document.getElementById('total-visitor').innerText = String(fakeGlobal).padStart(5, '0');
                }
            } else {
                const fakeGlobal = Math.floor(Date.now() / 10000000) + (localData.visits * 13);
                document.getElementById('total-visitor').innerText = String(fakeGlobal).padStart(5, '0');
            }
        };

        window.switchTab = (tabName) => {
            if (typeof window.playNoiseSound === 'function') window.playNoiseSound();
            
            const noise = document.getElementById('transition-noise');
            const hero = document.getElementById('hero-section');
            const navLinks = document.querySelectorAll('.menu-link');
            
            noise.style.display = 'block';
            gsap.to(noise, { opacity: 1, duration: 0.1, ease: "steps(1)", onComplete: () => {
                // ‚òÖ FIX: Try-catch block for safer rendering
                try {
                    if (tabName === 'works') {
                        hero.style.display = 'flex';
                        renderWorks();
                    } else if (tabName === 'logs') {
                        hero.style.display = 'none';
                        renderLogs();
                    } else if (tabName === 'achievements') {
                        hero.style.display = 'none';
                        renderAchievements(); 
                    }
                } catch(e) { console.error("Render Error:", e); }

                addHoverSounds();
                navLinks.forEach(link => link.classList.remove('active'));
                const activeLink = document.querySelector(`[data-tab="${tabName}"]`);
                if(activeLink) activeLink.classList.add('active');
                
                ScrollTrigger.refresh();
                initScrollTriggers();
                gsap.to(noise, { opacity: 0, duration: 0.5, delay: 0.1, ease: "power2.out", onComplete: () => {
                    noise.style.display = 'none';
                }});
            }});
        };

        // --- 5. Render Functions ---
        const renderWorks = () => {
            const container = document.getElementById('works-container');
            if (!container) return;
            
            // ‚òÖ CATEGORY TABS LOGIC ‚òÖ
            // 1. Get unique categories
            const categories = new Set(["ALL"]);
            worksData.forEach(w => {
                if(w.category) categories.add(w.category.toUpperCase());
                else categories.add("MOVIE"); // Default
            });

            // 2. Build Tabs HTML
            let tabsHtml = `<div class="category-tabs">`;
            categories.forEach(cat => {
                const isActive = (cat === currentCategory) ? 'active border-neon-cyan text-neon-cyan' : '';
                tabsHtml += `<button class="category-tab ${isActive}" data-cat="${cat}" onclick="filterWorks('${cat}')">${cat}</button>`;
            });
            tabsHtml += `</div>`;

            // 3. Filter Works
            const filteredWorks = (currentCategory === "ALL") 
                ? worksData 
                : worksData.filter(w => (w.category || "MOVIE").toUpperCase() === currentCategory);

            // 4. Render Content
            // Use array join to avoid potential string concatenation scope issues in loop
            const contentParts = [];
            
            // Header
            contentParts.push(`<div class="w-full text-center mb-10"><h2 class="font-impact text-5xl text-neon-cyan">MISSION LIST</h2></div>`);
            contentParts.push(tabsHtml);

            // Items
            filteredWorks.forEach((work, index) => { 
                const realIndex = worksData.indexOf(work);
                const isEven = index % 2 === 0;
                // ‚òÖ FIX: Removed skew/rotate, forced 0deg
                const rotate = '0deg';
                const direction = isEven ? 'flex-row' : 'flex-row-reverse';
                
                const adminControls = isAdmin ? `
                <div class="absolute -top-6 -left-6 z-[99999] pointer-events-auto cursor-pointer flex gap-2" onclick="event.stopPropagation();">
                    <button class="action-btn edit-btn" onclick="event.stopPropagation(); window.editItem('works', ${realIndex}); return false;">EDIT</button>
                    <button class="action-btn delete-btn" onclick="event.stopPropagation(); window.triggerDelete('works', ${realIndex}); return false;">DEL</button>
                </div>` : '';
                
                const html = `
                <div class="relative group w-full flex flex-col md:${direction} items-center gap-12 scroll-trigger-item mb-20">
                    ${adminControls}
                    <a href="${work.url}" target="_blank" class="w-full md:w-3/5 relative z-10" onclick="handleWorkClick('${work.id}')">
                        <div class="otaku-border bg-white ${work.colorClass || 'shadow-cyan'} transition-all duration-300">
                            <div class="overflow-hidden relative h-80 md:h-[500px]">
                                <img src="${work.image}" style="object-fit: cover;" class="w-full h-full group-hover:scale-110 transition-transform duration-700" alt="${work.title}" onerror="this.onerror=null; this.src='${work.fallback}';">
                            </div>
                            <div class="absolute top-0 left-0 bg-black text-white font-pixel px-2 py-1 text-lg">ID: ${work.fileId}</div>
                            <div class="sticker bg-${work.accent === '#e6b800' ? 'neon-yellow' : 'neon-pink'} text-black bottom-4 right-4 rotate-[-3deg]">${work.sticker}</div>
                        </div>
                    </a>
                    <div class="w-full md:w-2/5 flex flex-col items-start relative z-20">
                        <div>
                            <h3 class="title-impact text-6xl md:text-7xl text-black mb-4 leading-[0.85] hover-glitch cursor-default" style="text-shadow: 3px 3px 0px ${work.accent}">${work.title.split(' ').join('<br>')}</h3>
                        </div>
                        <div class="bg-white p-6 border-2 border-black shadow-[8px_8px_0px_#ccc] relative mt-6 w-full">
                             <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-neon-cyan via-neon-pink to-neon-yellow"></div>
                             <p class="font-sans font-bold text-black text-sm md:text-base leading-relaxed whitespace-pre-line">${work.desc.replace(/<br>/g, '\n')}</p>
                             <div class="mt-2 text-xs font-bold text-gray-400">CATEGORY: ${work.category || "MOVIE"}</div>
                        </div>
                        <a href="${work.url}" target="_blank" class="mt-8 self-end group/btn relative inline-block" onclick="handleWorkClick('${work.id}')">
                             <div class="bg-black text-white font-impact text-xl px-8 py-3 border-2 border-black group-hover/btn:bg-neon-cyan group-hover/btn:text-black group-hover/btn:scale-110 transition-all duration-300 shadow-[5px_5px_0px_#ccc]"><span>CHECK IT!</span></div>
                        </a>
                    </div>
                </div>`;
                
                contentParts.push(html);
            });
            
            container.innerHTML = contentParts.join('');
            addHoverSounds();
        };

        const renderLogs = () => {
            const container = document.getElementById('works-container');
            if (!container) return;

            // Use array join to avoid potential string concatenation scope issues in loop
            const contentParts = [];
            
            contentParts.push(`<div class="w-full text-center mb-10"><h2 class="font-impact text-5xl text-neon-pink">SYSTEM LOGS</h2></div>
                <div class="w-full max-w-4xl mx-auto bg-white border-4 border-black p-1 shadow-[10px_10px_0px_#ccc] font-pixel text-lg relative overflow-hidden">
                    <div class="relative z-10 p-6 flex flex-col h-full">
                        <div class="mb-4 text-neon-pink flex-shrink-0">> ACCESSING ARCHIVES... DONE.</div>
                        <div class="flex flex-col gap-6 h-96 overflow-y-auto log-scroll scroll-fade-mask pr-4">`);

            logsData.forEach((log, index) => {
                // ‚òÖ FIX: triggerDelete used here
                const adminControls = isAdmin ? 
                    `<div class="flex gap-2 ml-auto">
                        <button class="action-btn edit-btn" onclick="event.stopPropagation(); window.editItem('logs', ${index}); return false;">E</button>
                        <button class="action-btn delete-btn" onclick="event.stopPropagation(); window.triggerDelete('logs', ${index}); return false;">D</button>
                    </div>` : '';
                
                const logItem = `
                <div class="border-b border-gray-200 pb-4 group hover:bg-gray-50 transition-colors p-2 cursor-pointer flex justify-between items-start" onclick="openLog(${index})">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-1"><span class="text-neon-cyan">[${log.date}]</span><span class="bg-black text-white px-1 text-sm">${log.type}</span></div>
                        <p class="text-gray-800 font-sans text-sm md:text-base pl-4 border-l-2 border-neon-yellow group-hover:text-black transition-colors line-clamp-1">${log.text}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="text-[10px] text-neon-pink opacity-0 group-hover:opacity-100 transition-opacity">> READ MORE</div>
                        ${adminControls}
                    </div>
                </div>
                `;
                contentParts.push(logItem);
            });

            contentParts.push(`</div></div></div>`);
            
            container.innerHTML = contentParts.join('');
            addHoverSounds();
        };

        const renderAchievements = () => {
            const container = document.getElementById('works-container');
            const userData = getUserData();
            
            // Use array join
            const contentParts = [];
            contentParts.push(`<div class="w-full text-center mb-10"><h2 class="font-impact text-5xl text-neon-yellow">TROPHY ROOM</h2></div>
                <div class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 achievement-grid px-2">`);
            
            achievementsData.forEach(item => {
                const isUnlocked = userData.unlocked.includes(item.id);
                const statusClass = isUnlocked ? "border-neon-lime shadow-[0_0_15px_#2cb30e]" : "border-gray-300 opacity-50";
                const icon = isUnlocked ? item.icon : "üîí";
                const title = isUnlocked ? item.title : "???";
                const desc = isUnlocked ? item.desc : "Êù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶Ëß£Èô§„Åõ„Çà";
                
                const itemHtml = `
                <div class="bg-white border-2 ${statusClass} p-6 relative group flex flex-col items-center text-center">
                    <div class="h-24 w-24 bg-gray-100 mb-4 flex items-center justify-center text-5xl border border-gray-300">
                        ${icon}
                    </div>
                    <h3 class="font-impact text-xl ${isUnlocked ? 'text-neon-lime' : 'text-gray-400'} mb-2 leading-tight">${title}</h3>
                    <p class="font-sans text-xs text-gray-500 leading-tight">${desc}</p>
                    ${isUnlocked ? '<div class="absolute top-2 right-2 text-neon-lime font-pixel text-xs">UNLOCKED</div>' : ''}
                </div>
                `;
                contentParts.push(itemHtml);
            });
            
            contentParts.push(`</div>`);
            container.innerHTML = contentParts.join('');
            addHoverSounds();
        };

        // --- Init ---
        const initScrollTriggers = () => {
            ScrollTrigger.getAll().forEach(t => t.kill());
            gsap.utils.toArray('.scroll-trigger-item').forEach((item, i) => {
                const direction = i % 2 === 0 ? -50 : 50;
                gsap.fromTo(item, 
                    { opacity: 0, x: direction, rotation: direction > 0 ? 5 : -5 },
                    { opacity: 1, x: 0, rotation: 0, duration: 0.8, ease: "back.out(1.2)", 
                      scrollTrigger: { trigger: item, start: "top 80%", toggleActions: "play none none reverse" }
                    }
                );
            });
            ScrollTrigger.refresh();
        };

        const initAnimations = () => {
            gsap.registerPlugin(ScrollTrigger);
            const tl = gsap.timeline();
            tl.to("#loading-bar", { width: "100%", duration: 2.5, ease: "power2.inOut" })
              .to("#loading-text", { text: "COMPLETE!!", color: "#2cb30e", duration: 0.1, onStart: () => {
                  const txt = document.getElementById("loading-text");
                  txt.innerText = "COMPLETE!!";
                  txt.classList.replace("text-neon-cyan", "text-neon-lime");
                  document.getElementById("loading-sub").innerText = "SYSTEM READY";
              }})
              .to("#start-button", { opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" });

            addHoverSounds();

            document.getElementById("start-button").addEventListener("click", async () => {
                try { if (audioCtx.state === 'suspended') await audioCtx.resume(); playClickSound(); if (!isMuted) playBGM(); } catch(e) { console.log(e); }
                initFirebase().catch(e => console.log("Offline mode"));

                const noise = document.getElementById('transition-noise');
                const loadingScreen = document.getElementById("loading-screen");
                const mainContent = document.getElementById("main-content");
                
                // ‚òÖ PLAY SOUND & ANIMATION START ‚òÖ
                playClickSound(); // „Éî„ÉÉ
                
                setTimeout(() => {
                    if (!isMuted) playNoiseSound(); // „Ç∂„ÉºÔºàÈÅÖÂª∂ÂÆüË°åÔºâ
                    if (!isMuted) playBGM();

                    noise.style.display = 'block';
                    const tl = gsap.timeline();
                    
                    tl.to(noise, { opacity: 1, duration: 0.1, ease: "steps(1)" })
                      .call(() => {
                          gsap.set(".init-hidden", { opacity: 0 });
                          loadingScreen.style.display = "none";
                          mainContent.style.opacity = 1;
                          mainContent.style.visibility = "visible";
                          window.scrollTo(0, 0);
                      })
                      .to(noise, { opacity: 0, duration: 0.8, delay: 0.3, ease: "power2.out" })
                      .set(noise, { display: 'none' })
                      .call(() => {
                          const mainTl = gsap.timeline();
                          mainTl.fromTo(".title-impact", { scale: 1.5, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.8, ease: "back.out(1.7)" })
                                .fromTo(".otaku-border", { y: 100, opacity: 0, rotation: 10 }, { y: 0, opacity: 1, rotation: 1, duration: 1, ease: "power3.out" }, "-=0.6");
                          initScrollTriggers();
                      }, [], "<0.1");
                }, 300); // 0.3ÁßíÂæÖÊ©ü
            });
        };

        const initClock = () => {
            const updateTime = () => {
                const now = new Date();
                const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const timeEl = document.getElementById('time-display');
                const dateEl = document.getElementById('date-display');
                if(timeEl) {
                    dateEl.innerText = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} [${days[now.getDay()]}]`;
                    timeEl.innerText = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                }
            };
            setInterval(updateTime, 1000);
            updateTime();
        };

        const initCursor = () => {
            const cursor = document.getElementById('cursor');
            window.addEventListener('mousemove', (e) => {
                cursor.style.left = e.clientX + 'px';
                cursor.style.top = e.clientY + 'px';
                const rot = e.clientX * 0.5;
                cursor.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
            });
        };

        window.addEventListener('DOMContentLoaded', () => { initCursor(); });
        window.addEventListener('load', () => { renderWorks(); initAnimations(); initClock(); });

    </script>
</body>
</html>
